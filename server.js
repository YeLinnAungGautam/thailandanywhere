"use strict";

require("dotenv").config();

const request = require("request"),
    express = require("express"),
    { urlencoded, json } = require("body-parser"),
    app = express();

app.use(urlencoded({ extended: true }));

app.use(json());

app.get("/", function (_req, res) {
    res.send("Hello World");
});

app.get("/webhook", (req, res) => {
    const VERIFY_TOKEN = process.env.VERIFY_TOKEN;

    let mode = req.query["hub.mode"];
    let token = req.query["hub.verify_token"];
    let challenge = req.query["hub.challenge"];

    if (mode && token) {
        if (mode === "subscribe" && token === VERIFY_TOKEN) {
            console.log("WEBHOOK_VERIFIED");
            res.status(200).send(challenge);
        } else {
            res.sendStatus(403);
        }
    }
});

app.post("/webhook", (req, res) => {
    let body = req.body;

    if (body.object === "page") {
        body.entry.forEach(function (entry) {
            let webhookEvent = entry.messaging[0];
            let senderPsid = webhookEvent.sender.id;
            if (webhookEvent.message) {
                if (webhookEvent.message.quick_reply) {
                    const payload = webhookEvent.message.quick_reply.payload;
                    console.log("payload", payload);
                    handlePostback(
                        senderPsid,
                        webhookEvent.message.quick_reply
                    );
                } else {
                    Intro(senderPsid, webhookEvent.message);
                    // callSendAPI(senderPsid);
                }
                // if(!ChoosePackages(senderPsid,webhookEvent.message)){
                //     callSendAPI(senderPsid);
                // }
                // if(!KanchanaburiGroupTour(senderPsid,webhookEvent.message)){
                //     callSendAPI(senderPsid);
                // }
            } else {
                if (webhookEvent.postback) {
                    const postback = webhookEvent.postback;
                    console.log("postback", postback);
                    handlePostback(senderPsid, postback);
                }
            }
        });
        res.status(200).send("EVENT_RECEIVED");
    } else {
        res.sendStatus(404);
    }
});

async function Intro(senderPsid, receivedMessage) {
    let response;
    if (
        receivedMessage.text === "hi" ||
        receivedMessage.text == "HI" ||
        receivedMessage.text === "Hello" ||
        receivedMessage.text === "hello" ||
        receivedMessage.text === "Hi"
    ) {
        response = {
            text: `·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´·Äõ·Äæ·ÄÑ·Ä∑·Ä∫ üôè Thailand Anywhere ·Äô·Äæ ·ÄÄ·Äº·Ä≠·ÄØ·ÄÜ·Ä≠·ÄØ·Äï·Ä´·Äê·Äö·Ä∫·Åã·Äë·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·ÄÑ·Ä∂·Ä°·Äê·ÄΩ·ÄÑ·Ä∫·Ä∏ ·ÄÅ·Äõ·ÄÆ·Ä∏·Äû·ÄΩ·Ä¨·Ä∏·Äù·Äî·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äæ·ÄØ·Äî·Ä≤·Ä∑ ·Äï·Äê·Ä∫·Äû·Äê·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·ÄÄ·Ä∞·Ää·ÄÆ·Äñ·Ä≠·ÄØ·Ä∑·Ä°·Äû·ÄÑ·Ä∑·Ä∫·Äï·Ä´·Äõ·Äæ·ÄÑ·Ä∑·Ä∫·Åã Thailand Anywhere ·Åè ·Äù·Äî·Ä∫·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äæ·ÄØ·Äô·Äª·Ä¨·Ä∏·Ä°·Ä¨·Ä∏·Äú·ÄØ·Ä∂·Ä∏·ÄÄ·Ä≠·ÄØ ·Äû·Ä≠·Äõ·Äæ·Ä≠·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·Äê·ÄΩ·ÄÑ·Ä∫·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äª·Äö·Ä∫·Äï·Ä±·Ä∏·Äï·Ä´·Äî·Ä±·Ä¨·Ä∫·Åãüôá`,
            quick_replies: [
                {
                    content_type: "text",
                    title: "·Äú·Ä±·Äö·Ä¨·Ä•·Ä∫·Äú·ÄÄ·Ä∫·Äô·Äæ·Äê·Ä∫",
                    payload: "AIR_TIC",
                },
                {
                    content_type: "text",
                    title: "·Äü·Ä≠·ÄØ·Äê·Äö·Ä∫Booking",
                    payload: "HB",
                },
                {
                    content_type: "text",
                    title: "Group Tour",
                    payload: "GT",
                },
                {
                    content_type: "text",
                    title: "Private Van Tour",
                    payload: "PVT",
                },
                {
                    content_type: "text",
                    title: "Entrance tickets",
                    payload: "ET",
                },
                {
                    content_type: "text",
                    title: "Airport transfer",
                    payload: "AT",
                },
            ],
        };
    }
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, response);
}

async function ChoosePackages(senderPsid) {
    let response;
    response = {
        text: "Thailand Anywhere ·Äô·Äæ ·ÄÖ·ÄÆ·ÄÖ·Ä•·Ä∫·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ ·Ä°·Äï·Äê·Ä∫·ÄÖ·Ä•·Ä∫ ·ÄÖ·Äî·Ä± ·Åä ·Äê·Äî·ÄÑ·Ä∫·Äπ·ÄÇ‚Äå·Äî·ÄΩ·Ä±·Äî·Ä±·Ä∑·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ·Äë·ÄΩ·ÄÄ·Ä∫·Äû·Ä±·Ä¨ Group Tour ·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Ä•·Ä∫·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äõ·Äæ·ÄØ·Äô·Ää·Ä∫·Åã",
    };
    let responseTwo = {
        attachment: {
            type: "template",
            payload: {
                template_type: "generic",
                elements: [
                    {
                        title: "Kanchanaburi",
                        image_url:
                            "https://scontent-sin6-2.xx.fbcdn.net/v/t45.5328-4/306167946_5176274215818133_7958764666120436857_n.jpg?stp=dst-jpg_p960x960&_nc_cat=108&ccb=1-7&_nc_sid=c48759&_nc_ohc=CMKaUN4jt5sAX-05uP_&_nc_ht=scontent-sin6-2.xx&oh=00_AfDZmcwPtyySgpBFnrX8i5q5q9s1DeEmVTj0fvLJs72nXw&oe=63D4F962",
                        subtitle: "Every Friday at 7am\nPrice per Person",
                        buttons: [
                            {
                                type: "postback",
                                title: "Learn More",
                                payload: "KAN",
                            },
                            {
                                type: "postback",
                                title: "Go Back",
                                payload: "GROUP_TOUR_BAC1",
                            },
                        ],
                    },
                    {
                        title: "Khao Yai",
                        image_url:
                            "https://scontent-sin6-3.xx.fbcdn.net/v/t45.5328-4/286706997_5404239662998297_8288395513428964828_n.jpg?stp=dst-jpg_p960x960&_nc_cat=104&ccb=1-7&_nc_sid=c48759&_nc_ohc=q7B5wAtkS_UAX_4x0aX&_nc_ht=scontent-sin6-3.xx&oh=00_AfD0HjaWOPXOId0R9NK0R3ii3cFwdDVpxYuMQmPGb5U-rg&oe=63D40C8E",
                            subtitle: "Every Friday at 7am\nPrice per Person",
                        buttons: [
                            {
                                type: "postback",
                                title: "Learn More",
                                payload: "KHAO",
                            },
                            {
                                type: "postback",
                                title: "Go Back",
                                payload: "GROUP_TOUR_BAC2",
                            },
                        ],
                    },
                ],
            },
        },
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, response);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseTwo);
    //   return true;
}
async function KanchanaburiImages(senderPsid) {
    let responseOne = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_1.jpg",
            },
        },
    };
    let responseTwo = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_2.jpg",
            },
        },
    };
    let responseThree = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_3.jpg",
            },
        },
    };
    let responseFour = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_4.jpg",
            },
        },
    };
    let responseFive = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_5.jpg",
            },
        },
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseOne);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseTwo);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseThree);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseFour);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseFive);
}
async function KhoyaiGroupTourImages(senderPsid){
    let responseOne = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_1.jpg",
            },
        },
    };
    let responseTwo = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_2.jpg",
            },
        },
    };
    let responseThree = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_3.jpg",
            },
        },
    };
    let responseFour = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_4.jpg",
            },
        },
    };
    let responseFive = {
        attachment: {
            type: "image",
            payload: {
                url: "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_5.jpg",
            },
        },
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseOne);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseTwo);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseThree);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseFour);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseFive);
}
async function KanchanaburiGroupTour(senderPsid, receivedMessage) {
    let response;
    let responseOne = {
        text: "üáπüá≠üöêüå≥·Ä°·Äï·Äê·Ä∫·ÄÖ·Äâ·Ä∫ ·ÄÖ·Äî·Ä±·Äî·Ä±·Ä∑·Äê·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äë·ÄΩ·ÄÄ·Ä∫·ÄÅ·ÄΩ·Ä´·Äô·Äö·Ä∑·Ä∫ ·Äë·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·ÄÑ·Ä∂·Äõ·Ä≤·Ä∑ ·ÄÖ·Ä≠·Äê·Ä∫·Äñ·Ä≠·ÄÖ·ÄÆ·Ä∏·Äô·Äæ·ÄØ·ÄÄ·ÄÑ·Ä∫·Ä∏·Äô·Ä≤·Ä∑·Äá·ÄØ·Äî·Ä∫ ·Äñ·Äº·ÄÖ·Ä∫·Äê·Ä≤·Ä∑ ·ÄÄ·Äî·Ä∫·ÄÅ·Äª·Äî·Ä¨·Äï·Ä∞·Äõ·ÄÆ‚Äå ·Äî·Ä±·Ä∑·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äï·Äº·Äî·Ä∫ ·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Äâ·Ä∫·Äú·Ä±·Ä∏...üèûÔ∏è ·Äî·Ä±·Ä∑·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äï·Äº·Äî·Ä∫·Äû·ÄΩ·Ä¨·Ä∏·Äú·Ä≠·ÄØ·Ä∑·Äõ·Äê·Ä≤·Ä∑·Ä°·Äï·Äº·ÄÑ·Ä∫ ·Äï·ÄØ·Ä∂·Äô·Äæ·Äî·Ä∫·Äë·ÄÄ·Ä∫ ·ÄÄ·Ä¨·Ä∏·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·ÄÅ·Äª·Ä≠·Äî·Ä∫ 2 ·Äî·Ä¨·Äõ·ÄÆ ·Ä°·Äï·Ä≠·ÄØ ·Äû·ÄØ·Ä∂·Ä∏·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äú·Ä≠·ÄØ·Ä∑ ·ÄÄ·Äî·Ä∫·ÄÅ·Äª·Äî·Ä¨·Äï·Ä∞·Äõ·ÄÆ ·Äô·Äº·Ä≠·ÄØ·Ä∑·Äõ·Ä≤·Ä∑ ·Ä°·Äë·ÄÑ·Ä∫·ÄÄ·Äõ ·Äî·Ä±·Äõ·Ä¨‚Äå·Äê·Ä±·Ä¨·Ä∫·Äê·Ä±·Ä¨·Ä∫·Äô·Äª·Ä¨·Ä∏·Äô·Äª·Ä¨·Ä∏\n·ÄÄ·Ä≠·ÄØ·Äú·Ää·Ä∫·Ä∏ ·Äû·ÄΩ·Ä¨·Ä∏·Äú·Ää·Ä∫·Äú·Ä≠·ÄØ·Ä∑ ·Äõ·Äô·Äö·Ä∫·Åã üì∏\n·Ä°·Äô·Äæ·Äê·Ä∫·Äê·Äõ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏·ÄÖ·ÄΩ·Ä¨·ÄÄ·Ä≠·ÄØ ·ÄÖ·Ä≠·Äê·Ä∫·Äú·ÄΩ·Äê·Ä∫ ·ÄÄ·Ä≠·ÄØ·Äö·Ä∫·Äú·ÄΩ·Äê·Ä∫ ·Äñ·Äî·Ä∫·Äê·ÄÆ·Ä∏·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äñ·Ä≠·ÄØ·Ä∑ ·Äí·ÄÆ·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Äâ·Ä∫·Äë·Ä≤·Äô·Äæ·Ä¨ ·Äî·Ä±·Äõ·Ä¨·Äú·Äæ·Äú·Äæ·Äú·Ä±·Ä∏·Äê·ÄΩ·Ä± ·Äë·Ää·Ä∑·Ä∫·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äõ·Ä±·Ä∏·ÄÜ·ÄΩ·Ä≤‚Äå·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äï·Ä´·Äê·Äö·Ä∫·Åã\n-------------------------------------------------\n·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Äâ·Ä∫·Äë·Ä≤·Ä¨·Äú·Ää·Ä∫·Äï·Äê·Ä∫·Äô·Äö·Ä∑·Ä∫ ·Äî·Ä±·Äõ·Ä¨·Äê·ÄΩ·Ä±·ÄÄ·Äê·Ä±·Ä¨·Ä∑ ...üôèüôèüôè ·ÄÄ·Äî·Ä∫·ÄÅ·Äª·Äî·Ä¨·Äï·Ä∞·Äõ·ÄÆ·Äô·Äº·Ä≠·ÄØ·Ä∑·Äõ·Ä≤·Ä∑ ·Ä°·Äë·ÄÑ·Ä∫·ÄÄ·Äõ·Äî·Ä±·Äõ·Ä¨·Äê·ÄΩ·Ä± ·Äñ·Äº·ÄÖ·Ä∫·Äê·Ä≤·Ä∑ ·Äî·Ä¨·Äô·Ää·Ä∫·ÄÄ·Äª·Ä±·Ä¨·Ä∫ ·ÄÜ·ÄØ·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äï·Äº·Ää·Ä∑·Ä∫ Wat Tham Suea ·ÄÄ·Äª·Ä¨·Ä∏·Äò·ÄØ·Äõ·Ä¨·Ä∏ ·Åäüåâüõ§Ô∏è ·ÄÄ·Äî·Ä∫·ÄÅ·Äª·Äî·Ä¨·Äï·Ä∞·Äõ·ÄÆ·Äô·Äº·Ä≠·ÄØ·Ä∑·Äõ·Ä≤·Ä∑ ·Äî·Ä¨·Äô·Ää·Ä∫·ÄÄ·Äª·Ä±·Ä¨·Ä∫ ·ÄÄ·ÄΩ·Ä±·Ä∏·Äô·Äº·ÄÖ·Ä∫‚Äå·Äò·Ä±·Ä∏·ÄÄ ·Äû·Ä±·Äô·ÄÑ·Ä∫·Ä∏·Äê·Äô·Äî·Ä∫·Äõ·Äë·Ä¨·Ä∏·Äú·Äô·Ä∫·Ä∏·Äï·Ä±·Ä´·Ä∫·Äõ·Äæ·Ä≠ River Kwai ·Äê·Ä∂·Äê·Ä¨·Ä∏·Åäü•óü•£·ÄÄ·ÄΩ·Ä±·Ä∏·Äô·Äº·ÄÖ·Ä∫·Äë·Ä≤·ÄÄ ·Äõ·Ä±·Äï·Ä±·Ä´·Ä∫‚Äå·ÄÖ·Ä¨·Ä∏·Äû·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·Ä≠·ÄØ·ÄÑ·Ä∫·Äú·Ä±·Ä∏·Äñ·Äº·ÄÖ·Ä∫·Äê·Ä≤·Ä∑ Floating Raft Restaurant ·ÄÖ·Ä¨·Ä∏·Äû·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·Ä≠·ÄØ·ÄÑ·Ä∫·ÅäüèûÔ∏èüåä Sai Yok Noi ·Äõ·Ä±·Äê·Ä∂·ÄÅ·ÄΩ·Äî·Ä∫·Åäüå∏üçÇ‚òï ·Äô·Ä¨·ÄÇ·Äõ·ÄÄ·Ä∫·Äï·Äî·Ä∫·Ä∏·ÄÅ·ÄÑ·Ä∫·Ä∏·ÄÄ·Äº·ÄÆ·Ä∏·Äî·Ä≤·Ä∑ ·Äì·Ä¨·Äê·Ä∫·Äï·ÄØ·Ä∂·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äú·Ä≠·ÄØ·Ä∑ ·Ä°·Äõ·Äô·Ä∫·Ä∏·Äú·Äæ·Äê·Ä≤·Ä∑ Chan Nature Cafe·Åäüå≥üíØ ·Äî·Äæ·ÄÖ·Ä∫·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·Äê·ÄÖ·Ä∫·Äõ·Ä¨·ÄÄ·Äª·Ä±·Ä¨·Ä∫ ·Äû·ÄÄ·Ä∫·Äê·Äô·Ä∫·Ä∏·Äõ·Äæ·Ä≠·Äê·Ä≤·Ä∑ ·Äì·Ä¨·Äê·Ä∫·Äï·ÄØ·Ä∂·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äú·Ä≠·ÄØ·Ä∑·Ä°·Äõ·Äô·Ä∫·Ä∏·Äú·Äæ·Äê·Ä≤·Ä∑ Giant Rain Tree·ÄÖ·Äê·Ä≤·Ä∑  ·Äî·Ä±·Äõ·Ä¨ 6 ·ÄÅ·ÄØ·Äú·ÄØ·Ä∂·Ä∏·ÄÄ·Ä≠·ÄØ ·Äú·Ää·Ä∫·Äï·Äê·Ä∫·Äñ·Ä≠·ÄØ·Ä∑·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äï·Ä´·Äï·Ä≠·ÄØ·Ä∑‚Äå·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫ ·Äï·Ä±·Ä∏·Äô·Äæ·Ä¨ ·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã‚è∞·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Äâ·Ä∫·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ ·ÄÖ·ÄØ·Äõ·Äï·Ä∫·ÄÄ·Äê·Ä±·Ä¨·Ä∑ Platinum Mall ·Ä°·Äõ·Äæ·Ä±·Ä∑·Äô·Äæ·Ä¨ ·Äô·Äî·ÄÄ·Ä∫ 7 ·Äî·Ä¨·Äõ·ÄÆ ·ÄÜ·ÄØ·Ä∂·ÄÄ·Äº·Äô·Äæ·Ä¨ ·Äñ·Äº·ÄÖ·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·Ää 9 ·Äî·Ä¨·Äõ·ÄÆ·Äô·Äæ·Ä¨ Platinum Mall ·Ä°·Äõ·Äæ·Ä±·Ä∑·ÄÄ·Ä≠·ÄØ ·Äï·Äº·Äî·Ä∫·Äú·Ää·Ä∫·Äï·Ä≠·ÄØ·Ä∑·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äï·Ä±·Ä∏·Äô·Äæ·Ä¨ ·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã\n-------------------------------------------------\nü§óüöê·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Äâ·Ä∫·Ä°·Äê·ÄΩ·ÄÄ·Ä∫ Luxury Van ·Äî·Ä≤·Ä∑·ÄÖ·ÄÆ·ÄÖ·Äâ·Ä∫·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äï·Äº·ÄÆ·Ä∏ ·ÄÄ·Ä¨·Ä∏·Äë·Ä≤·Äô·Äæ·Ä¨  üì∫TV ,Aircon ·Ä°·ÄÖ·ÄØ·Ä∂·Ä°·Äú·ÄÑ·Ä∫·Äî·Ä≤·Ä∑  ·Äú·Ä∞ 4 ·Äö·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Äº·Ää·Ä∑·Ä∫·Äê·Ä¨·Äî·Ä≤·Ä∑ ·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Äâ·Ä∫·Äú·Ä±·Ä∏·ÄÄ·Ä≠·ÄØ ·Äá·Ä≠·Äô·Ä∫·Äõ·Äæ·Ä≠·Äõ·Äæ·Ä≠ ·ÄÖ·Äë·ÄΩ·ÄÄ·Ä∫·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äô·Äæ·Ä¨·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã\n·ÄÖ·Äõ·Ä≠·Äê·Ä∫·ÄÑ·Äº·Ä≠·Äô·Ä∫·Ä∏ ·ÄÅ·Äõ·ÄÆ·Ä∏·ÄÖ·Äâ·Ä∫ ·Äñ·Äº·ÄÖ·Ä∫·Äï·Äº·ÄÆ·Ä∏ ·Ä°·ÄÅ·Äª·Ä≠·Äî·Ä∫ 14 ·Äî·Ä¨·Äõ·ÄÆ·ÄÄ·Äº·Ä¨·Äë·Ä≠ ·ÄÄ·Ä¨·Ä∏ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äï·Äº·ÄÆ·Ä∏ üî∞·Äù·ÄÑ·Ä∫·ÄÄ·Äº·Ä±·Ä∏·Äô·Äª·Ä¨·Ä∏üî∞·ÄÄ·Ä¨·Ä∏·ÄÅ üî∞·ÄÜ·ÄÆ·Äñ·Ä≠·ÄØ·Ä∏üî∞·Äî·Ä±·Ä∑·Äú·Ää·Ä∫·ÄÖ·Ä¨ ·Ä°·Äï·Äº·ÄÑ·Ä∫ Chan Nature Cafe ·Äô·Äæ·Ä¨ ·ÄÄ·Äº·Ä≠·ÄØ·ÄÄ·Ä∫·Äî·Äæ·ÄÖ·Ä∫·Äû·ÄÄ·Ä∫·Äõ·Ä¨ Drink ·Äê·ÄÖ·Ä∫·ÄÅ·ÄΩ·ÄÄ·Ä∫ ·Äû·Ä±·Ä¨·ÄÄ·Ä∫·Äú·Ä≠·ÄØ·Ä∑·Äõ·Äô·Äæ·Ä¨·Äñ·Äº·ÄÖ·Ä∫·Äï·Äº·ÄÆ·Ä∏  ·Ä°·Äï·Ä≠·ÄØ·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏ ·Äë·Äï·Ä∫·Äï·Ä±·Ä∏·ÄÖ·Äõ·Ä¨·Äô·Äú·Ä≠·ÄØ·Äï·Ä´·Äñ·Ä∞·Ä∏·Åã\nüíØ·ÄÖ·Äª·Ä±·Ä∏ ·Äî·Äæ·ÄØ·Äî·Ä∫·Ä∏·Ä°‚Äå·Äî·Ä±·Äî·Ä≤·Ä∑ ·ÄÖ·Äõ·Ä≠·Äê·Ä∫·ÄÑ·Äº·Ä≠·Äô·Ä∫·Ä∏ ·Ä°·Äï·Äº·ÄÆ·Ä∏·Ä°·ÄÖ·ÄÆ·Ä∏ ·ÄÄ·Ä≠·ÄØ·Äô·Äæüî∏ ·Äê·ÄÖ·Ä∫·Ä¶·Ä∏·ÄÄ·Ä≠·ÄØ  ·Äò·Äê·Ä∫ 1850  ·Äï·Ä≤ ·ÄÄ·Äª·Äû·ÄÑ·Ä∑·Ä∫·Äô·Äæ·Ä¨ ·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·ÅãüíØ·Äú·Ä∞·Ä¶·Ä∏·Äõ·Ä± ·Ä°·ÄÄ·Äî·Ä∑·Ä∫·Ä°·Äû·Äê·Ä∫·Äõ·Äæ·Ä≠·Äê·Ä¨·Äñ·Äº·ÄÖ·Ä∫·Äú·Ä≠·ÄØ·Ä∑ ·Äú·Ä∞·Äô·Äï·Äº·Ää·Ä∑·Ä∫·ÄÅ·ÄÑ·Ä∫ ·Ä°·Äô·Äº·Äî·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·ÄÄ·Äº·Ä≠·ÄØ·Äï·Ä±·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äê·Ä±·Ä¨·Ä∑·Äî·Ä±·Ä¨·Ä∫ ü§óü§óü§ó·Äú·Ä∞·Äô·Äª·Ä¨·Ä∏·Äú·Ä± ·Äï·Ä≠·ÄØ·Äê·Äî·Ä∫·Äú·Ä±·Äï·Ä≤·Äñ·Äº·ÄÖ·Ä∫·Äú·Ä≠·ÄØ·Ä∑ ·Äô·Ä≠·Äû·Ä¨·Ä∏·ÄÖ·ÄØ·Äê·ÄΩ·Ä± ·Äû·Ä∞·ÄÑ·Äö·Ä∫·ÄÅ·Äª·ÄÑ·Ä∫·Ä∏·Äê·ÄΩ·Ä±·Äî·Ä≤·Ä∑ ·Äï·Ä≠·Äê·Ä∫·Äõ·ÄÄ·Ä∫·Äô·Äæ·Ä¨ ·Äú·Äª·Äæ·Ä±·Ä¨·ÄÄ·Ä∫·Äú·Ää·Ä∫·Äñ·Ä≠·ÄØ·Ä∑·Ä°·Äê·ÄΩ·ÄÄ·Ä∫üì≤ ·Ä°·Äô·Äº·Äî·Ä∫·Äú·Ä∞·ÄÖ·ÄØ·Äï·Äº·ÄÆ·Ä∏ ·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äï·Ä±·Ä∏·Äñ·Ä≠·ÄØ·Ä∑ ·Äñ·Ä≠·Äê·Ä∫·ÄÅ·Ä±·Ä´·Ä∫·Äï·Ä´·Äê·Äö·Ä∫·Åã",
    };
    response = {
        attachment: {
            type: "template",
            payload: {
                template_type: "generic",
                elements: [
                    {
                        title: "Have Fun",
                        image_url:
                            "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_2.jpg",
                        buttons: [
                            {
                                type: "postback",
                                title: "Book Now",
                                payload: "CHOOSE_DAYANDTIME",
                            },
                            {
                                type: "postback",
                                title: "Talk To Agent",
                                payload: "KAN_DET_TALK_TO AGENT",
                            },
                            {
                                type: "postback",
                                title: "Go Back",
                                payload: "GB_KAN",
                            },
                        ],
                    },
                ],
            },
        },
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseOne);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, response);
}
async function ChooseDateAndTimeForKanchanaburi(senderPsid) {
    let responseOne = {
        text: "When would you like to book?",
        quick_replies: [
            {
                content_type: "text",
                title: "This Friday",
                payload: "THIS_F_KANCHANABURI",
            },
            {
                content_type: "text",
                title: "Next Friday",
                payload: "NEXT_F_KANCHANABURI",
            },
            {
                content_type: "text",
                title: "Future Dates",
                payload: "FUTURE_D_KANCHANABURI",
            },
            {
                content_type: "text",
                title: "Talk To Agent",
                payload: "TALK_TO_AGENT_KANCHANABURI",
            },
        ],
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseOne);
}
async function ChooseDateAndTimeForKhoYai(senderPsid) {
    let responseOne = {
        text: "When would you like to book?",
        quick_replies: [
            {
                content_type: "text",
                title: "This Friday",
                payload: "THIS_F_KHOYAI",
            },
            {
                content_type: "text",
                title: "Next Friday",
                payload: "NEXT_F_KHOYAI",
            },
            {
                content_type: "text",
                title: "Future Dates",
                payload: "FUTURE_D_KHOYAI",
            },
            {
                content_type: "text",
                title: "Talk To Agent",
                payload: "TALK_TO_AGENT_KHOYAI",
            },
        ],
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseOne);
}
async function ChooseDate(senderPsid) {
    let responseOne = {
        text: "Please Give Us Your date",
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseOne);
}
async function TalkToAgent(senderPsid) {
    let response;
    response = {
        text: "Our travel assistant will get back to you with availability status",
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, response);
}
async function KhaoyaiGroupTour(senderPsid, receivedMessage) {
    let response;
    let responseOne = {
        text: "Just Hello",
    };
    response = {
        attachment: {
            type: "template",
            payload: {
                template_type: "generic",
                elements: [
                    {
                        title: "Have Fun",
                        image_url:
                            "http://thailandanywhere.npthosting.cyou/kanchanaburi_grouptour_2.jpg",
                        buttons: [
                            {
                                type: "postback",
                                title: "Book Now",
                                payload: "CHOOSE_DAYANDTIME_KHOYAI_DET",
                            },
                            {
                                type: "postback",
                                title: "Talk To Agent",
                                payload: "KHOYAI_DET_TALK_TO AGENT",
                            },
                            {
                                type: "postback",
                                title: "Go Back",
                                payload: "GB_KHOYAI",
                            },
                        ],
                    },
                ],
            },
        },
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, responseOne);
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, response);
}
async function TripDetailsForKanchanaburi(senderPsid) {
    let message = {
        text: "·ÄÄ·Äª·ÄΩ·Äî·Ä∫·Äê·Ä±·Ä¨·Ä∫·Äû·Ää·Ä∫ Kanchanaburi ·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫",
    };
    sendTypingOn(senderPsid, "typing_on");
    await callSendAPI(senderPsid, message);
}
async function makingBooking(senderPsid, payload) {
    if (
        payload === "MKB_KAN" ||
        payload === "KHAOYAI_BKG" ||
        payload === "THIS_F_KANCHANABURI" ||
        payload === "FUTURE_D_KANCHANABURI" ||
        payload === "NEXT_F_KANCHANABURI" ||
        payload === "THIS_F_KHOYAI" ||
        payload === "NEXT_F_KHOYAI" ||
        payload === "FUTURE_D_KHOYAI" 
    ) {
        let responseOne = {
            text: "Please confirm your booking for this Friday by paying 10% deposit. How would you like to Pay.",
        };

        let responseTwo = {
            attachment: {
                type: "template",
                payload: {
                    template_type: "generic",
                    elements: [
                        {
                            title: "How would you like to pay",
                            image_url:
                                "https://www.nttdata.com/th/en/-/media/nttdataapac/ndth/services/card-and-payment-services/services_card_and_payment_services_header_2732x1536_1.jpg?h=1536&iar=0&w=2732&rev=cda4f237fa8c46248b1376544031309e",
                            subtitle: "Online",
                            buttons: [
                                {
                                    type: "postback",
                                    title: "KBZ Bank",
                                    payload: "ACC_KBZ",
                                },
                                {
                                    type: "postback",
                                    title: "Thai Bank",
                                    payload: "ACC_THAI",
                                },
                            ],
                        },
                    ],
                },
            },
        };
        sendTypingOn(senderPsid, "typing_on");
        await callSendAPI(senderPsid, responseOne);
        sendTypingOn(senderPsid, "typing_on");
        await callSendAPI(senderPsid, responseTwo);
    }
}

// Handles messaging_postbacks events
async function handlePostback(senderPsid, receivedPostback) {
    let response;
    console.log("Hello I am here");
    let payload = receivedPostback.payload;

    if (payload === "GT") {
        ChoosePackages(senderPsid);
    } else if (payload === "KAN") {
        await KanchanaburiImages(senderPsid);
        await KanchanaburiGroupTour(senderPsid);
    } else if (payload === "KAN_DET") {
        TripDetailsForKanchanaburi(senderPsid);
    } else if (payload === "MKB_KAN") {
        makingBooking(senderPsid, payload);
    } 
    //Start Kha Yai Group Tour
    else if (payload === "KHAO") {
        await KhoyaiGroupTourImages(senderPsid);
        await KhaoyaiGroupTour(senderPsid);
    } else if(payload === "KHOYAI_DET_TALK_TO AGENT"){
        TalkToAgent(senderPsid);
    }
    else if(payload === "GB_KHOYAI"){
        ChoosePackages(senderPsid);
    }
    else if(payload === "CHOOSE_DAYANDTIME_KHOYAI_DET"){
        ChooseDateAndTimeForKhoYai(senderPsid);
    }
    else if(payload === "THIS_F_KHOYAI"){
        makingBooking(senderPsid, payload);
    }
    else if(payload === "NEXT_D_KHOYAI"){
        makingBooking(senderPsid, payload);
    }
    else if(payload === "FUTURE_D_KHOYAI"){
        ChooseDate(senderPsid);
        makingBooking(senderPsid, payload);
    }
    else if(payload === "TALK_TO_AGENT_KHOYAI"){
        TalkToAgent(senderPsid);
    }
    //End KhoYai Group Tour
    else if (payload === "KAN_DET_TALK_TO AGENT") {
        TalkToAgent(senderPsid);
    } else if (payload === "CHOOSE_DAYANDTIME") {
        ChooseDateAndTimeForKanchanaburi(senderPsid);
    } else if (payload === "FUTURE_D_KANCHANABURI") {
        ChooseDate(senderPsid);
        makingBooking(senderPsid, payload);
    } else if (payload === "THIS_F_KANCHANABURI") {
        makingBooking(senderPsid, payload);
    } else if (payload === "NEXT_F_KANCHANABURI") {
        makingBooking(senderPsid, payload);
    } else if (payload === "TALK_TO_AGENT_KANCHANABURI") {
        TalkToAgent(senderPsid);
    }else if (payload === "GB_KAN"){
        ChoosePackages(senderPsid);
    } 
    else {
        await callSendAPI(senderPsid, response);
    }
}

async function callSendAPI(senderPsid, response) {
    const PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;

    let requestBody = {
        recipient: {
            id: senderPsid,
        },
        message: response,
    };

    return new Promise((resolve, reject) => {
        request(
            {
                uri:
                    "https://graph.facebook.com/v15.0/me/messages?access_token=" +
                    PAGE_ACCESS_TOKEN,
                qs: { access_token: PAGE_ACCESS_TOKEN },
                method: "POST",
                json: requestBody,
            },
            (err, _res, _body) => {
                if (!err) {
                    console.log("Message sent!");
                    resolve(_res);
                } else {
                    console.error("Unable to send message:" + err);
                    reject(err);
                }
            }
        );
    });
}
function sendTypingOn(senderPsid, actions) {
    const PAGE_ACCESS_TOKEN = process.env.PAGE_ACCESS_TOKEN;

    let requestBody = {
        recipient: {
            id: senderPsid,
        },
        sender_action: actions,
    };

    request(
        {
            uri:
                "https://graph.facebook.com/v15.0/me/messages?access_token=" +
                PAGE_ACCESS_TOKEN,
            qs: { access_token: PAGE_ACCESS_TOKEN },
            method: "POST",
            json: requestBody,
        },
        (err, _res, _body) => {
            if (!err) {
                console.log("Message sent!");
            } else {
                console.error("Unable to send message:" + err);
            }
        }
    );
}
const listener = app.listen(process.env.PORT, function () {
    console.log("Your app is listening on port " + listener.address().port);
});
